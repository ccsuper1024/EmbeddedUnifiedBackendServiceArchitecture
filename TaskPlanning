嵌入式统一后端服务架构开发任务规划

一、规划原则

- 优先搭建骨干框架，再逐步补充协议和业务细节
- 始终保证可编译、可运行、可回滚
- 每个阶段都引入必要的自动化测试与日志，便于定位问题
- 在树莓派5B 环境下持续验证性能与资源占用

二、阶段整体划分

阶段 0：工程与基础设施搭建
阶段 1：核心运行时与线程模型
阶段 2：协议与 Session 支持
阶段 3：Lua 集成与业务脚本框架
阶段 4：磁盘 IO、日志与录制管线
阶段 5：外部服务接入（Redis/MySQL/PostgreSQL/Kafka）
阶段 6：性能优化与压测
阶段 7：测试体系与文档完善

三、阶段 0：工程与基础设施搭建

0.1 工程初始化
- 使用 CMake 创建基础工程结构（src/include/tests 目录等）
- 配置编译选项，区分 Debug/Release，针对树莓派5B 交叉编译/本地编译配置
- 引入 git 管理，建立基础分支策略（main/dev/feature-*）

0.2 第三方库与工具集成
- 集成 googletest，搭建基础单元测试框架与示例用例
- 集成 spdlog，提供统一日志接口
- 预留 protobuf/JSON 相关依赖（按需要决定具体库）

0.3 基础运行程序
- 实现最小可运行主程序（main）：
  - 加载配置文件
  - 初始化日志
  - 打印启动信息
0.4 阶段回测与提交
- 编写并使用回测脚本（如 ./regression.sh）完成构建与全部单元测试
- 将阶段 0 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

四、阶段 1：核心运行时与线程模型

1.1 配置与主线程
- 定义配置结构体（端口、线程数、队列大小、日志级别等）
- 从文件加载配置，提供命令行参数覆盖能力
- 主线程初始化各线程池和队列，启动后进入事件循环或管理循环

1.2 线程创建与生命周期管理
- 实现线程抽象类/工具函数
- 创建：
  - TCP IO 线程组
  - UDP IO 线程组
  - Worker 线程池
  - 磁盘线程池
  - 日志线程
  - 定时器线程
- 提供统一的线程启动、停止和优雅退出机制

1.3 任务队列与无锁结构
- 设计并实现 MPSC ring buffer 任务队列
- 对任务类型进行枚举和结构体定义（TcpTask、UdpTask、TimerTask、DiskTask、LogTask 等）
- 为 IO → Worker、Worker → IO、Worker → Disk、Worker → Log 建立对应队列
- 编写单元测试验证队列正确性与性能特征
1.4 阶段回测与提交
- 使用回测脚本（./regression.sh）完成本阶段的构建与全部单元测试
- 将阶段 1 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

五、阶段 2：协议与 Session 支持

2.1 基础网络 IO
- 封装 socket 创建、bind、listen、accept、connect 等基础操作
- 封装 epoll 注册与事件处理循环
- TCP IO 线程实现：
  - accept 新连接
  - 非阻塞 recv/send
  - 连接关闭与异常处理
- UDP IO 线程实现：
  - 非阻塞 recvfrom/sendto
  - 基础包大小和错误处理

2.2 Conn 结构与 Session 表
- 设计 Conn 结构体（连接状态、缓冲区、绑定 Worker、协议标识等）
- 实现 TCP 连接表管理（增删查改、超时处理）
- 实现 UDP Session 表（基于 src_ip:port 或业务 ID）
- 实现 RTP Session 表（基于 SSRC）

2.3 协议插件接口
- 定义协议处理接口：
  - 解析函数：parse()
  - 打包函数：encode()
  - Session 关联规则
- 提供注册机制，允许添加 SIP、RTSP、MQTT 等协议实现

2.4 统一事件抽象
- 设计统一 Event/Message 结构：
  - 协议类型
  - Session/Conn 信息
  - 上下文属性（时间戳、来源地址等）
  - 业务负载
- 在 IO 线程解析后，将统一事件投递到 Worker
2.5 阶段回测与提交
- 使用回测脚本（./regression.sh）完成本阶段的构建与全部测试
- 将阶段 2 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

六、阶段 3：Lua 集成与业务脚本框架

3.1 Lua VM 管理
- 选型并引入 Lua（版本与实现）
- 实现 Lua VM 包装类：
  - 初始化 VM
  - 加载脚本与模块
  - 错误捕获与日志记录
- 为每个 Worker 创建并绑定一个 Lua VM 实例

3.2 C++ 与 Lua 交互接口
- 暴露网络事件回调给 Lua：
  - lua_on_tcp_message
  - lua_on_udp_signal
  - lua_on_timer
  - lua_on_disk_done 等
- 提供 Lua 调用 C++ 的接口：
  - 发送数据（发送到某连接/某会话）
  - 发起磁盘任务
  - 发起外部服务访问请求

3.3 Lua 脚本框架
- 设计 Lua 侧模块化结构：
  - 协议处理模块
  - 业务路由模块
  - 配置模块
- 提供示例脚本与简易 Demo，验证从网络 → Lua → 网络的完整闭环

3.4 热更新与配置驱动
- 设计脚本热更新机制：
  - 加载新脚本到新 VM 或在安全点替换
  - 回滚机制：更新失败时恢复旧版本
- 将业务路由和协议绑定配置化，使得升级主要集中在脚本和配置层
3.5 阶段回测与提交
- 使用回测脚本完成本阶段的构建与测试（重点验证 Lua 与 C++ 交互链路）
- 将阶段 3 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

七、阶段 4：磁盘 IO、日志与录制管线

4.1 日志管线
- 基于 spdlog 封装统一日志 API
- 实现 LogTask 队列与日志线程：
  - 支持批量写入
  - 配置日志级别与输出路径
- 针对关键模块（网络、队列、Lua、磁盘、外部服务）定义基础日志规范

4.2 磁盘任务管线
- 定义 DiskTask 类型（READ、WRITE、APPEND 等）
- 实现 Disk 线程池：
  - 处理 DiskTask
  - 完成后回调 Worker
- 支持 HTTP 文件读取和简单文件服务 Demo

4.3 RTP 录制路径
- 在 UDP IO 线程实现 RTP 数据分类与环形缓冲写入
- 实现录制线程对环形缓冲的批量读写到文件
- 编写简单回放/检查工具或测试用例验证录制文件正确性

4.4 状态持久化
- 定义 Lua 状态持久化 API（如保存房间状态、用户状态等）
- 通过 DiskTask(APPEND) 将状态落盘
- 实现基本的启动恢复逻辑（从持久化文件加载状态）
4.5 阶段回测与提交
- 使用回测脚本完成本阶段构建与测试（含磁盘相关用例）
- 将阶段 4 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

八、阶段 5：外部服务接入

5.1 Redis 客户端
- 集成 Redis 客户端库
- 封装异步或半异步接口：
  - Lua 发起 Redis 请求
  - 完成后回调 Lua
- 设计基础使用模式（缓存、简单队列等）

5.2 数据库访问（MySQL/PostgreSQL）
- 选型并集成数据库访问库
- 实现连接池管理
- 提供 SQL 执行与结果回调接口给 Lua
- 编写典型查询/写入操作示例

5.3 Kafka 接入
- 集成 Kafka 客户端库
- 实现生产者/消费者封装
- 为 Lua 提供简单 Topic 发送与订阅接口

5.4 容错与重连机制
- 对 Redis/数据库/Kafka 建立统一的重连与错误处理策略
- 对关键错误进行日志上报与告警
5.5 阶段回测与提交
- 使用回测脚本完成本阶段构建与测试（含外部服务相关场景）
- 将阶段 5 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

九、阶段 6：性能优化与压测

6.1 基准测试与压测工具
- 编写压测工具或脚本：
  - 大量 TCP 连接并发收发
  - 大量 UDP 包（含 RTP）压测
- 在树莓派5B 上实际运行，采集指标

6.2 性能瓶颈分析
- 针对 CPU 使用率、内存占用、队列长度、延迟等指标进行分析
- 定位热点模块：任务队列、协议解析、Lua 调用、磁盘 IO 等

6.3 优化措施落地
- 引入或优化内存池
- 优化无锁队列实现、减少 cache miss
- 分级队列和背压机制，避免队列爆炸
- 对日志和录制做进一步批量优化和采样控制
6.4 阶段回测与提交
- 使用回测脚本和压测脚本组合验证性能与稳定性
- 将阶段 6 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

十、阶段 7：测试体系与文档完善

7.1 单元测试与集成测试
- 补充和完善各模块单元测试：
  - Conn 管理、Session 表
  - 队列与线程模型
  - 协议解析与打包
  - Lua 桥接与脚本逻辑
  - 磁盘与外部服务访问
- 设计端到端集成测试场景：
  - 从客户端 → 多协议 → Lua → 外部服务 → 响应

7.2 长稳与故障注入测试
- 设计长时间运行场景（小时级/天级）
- 在运行中注入各种故障：
  - 网络抖动、连接大量建立/关闭
  - 磁盘 IO 变慢
  - 外部服务不可用
- 验证系统恢复能力与资源泄漏情况（内存、句柄等）

7.3 文档体系
- 输出开发相关文档：
  - 编译与部署指南
  - 配置说明与示例
  - Lua API 与编程指南
- 输出运维相关文档：
  - 日志与指标说明
  - 常见故障及排查步骤
7.4 阶段回测与提交
- 使用回测脚本执行全量测试和关键集成测试
- 将阶段 7 的改动使用 git 提交并推送到 git@github.com:ccsuper1024/EmbeddedUnifiedBackendServiceArchitecture.git

十一、里程碑与验收标准（示例）

- 里程碑 M1：基础工程与核心运行时可运行
  - 可以在树莓派5B 上启动进程，接收简单 TCP/UDP 请求并回显

- 里程碑 M2：多协议 + Lua 业务闭环
  - 支持至少 2 种协议（如 TCP 自定义协议 + UDP 控制）
  - 业务逻辑完全由 Lua 编写并可热更新

- 里程碑 M3：完整磁盘与录制管线
  - 支持 HTTP 文件服务、结构化日志、RTP 录制与回放

- 里程碑 M4：外部服务可用
  - 可与 Redis/MySQL/PostgreSQL/Kafka 完成典型业务流程

- 里程碑 M5：10 万连接级 + 长稳验证
  - 在目标硬件上达到设计并发量
  - 通过长稳与故障注入测试，无显著内存泄漏和异常崩溃
